module.exports=[93695,(e,t,a)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},70406,(e,t,a)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},18622,(e,t,a)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},35930,5625,e=>{"use strict";var t=e.i(64328);let a=new t.Schema({unitId:{type:String,required:!0},type:{type:String,required:!0},x:{type:Number,required:!0},y:{type:Number,required:!0},hp:{type:Number,required:!0},owner:{type:String,required:!0}},{_id:!1}),r=new t.Schema({x:{type:Number,required:!0},y:{type:Number,required:!0},itemType:{type:String,required:!0}},{_id:!1}),n=new t.Schema({units:{type:[a],default:[]},blockedTiles:{type:[r],default:[]}},{_id:!1}),i=new t.Schema({battleId:{type:String,required:!0,unique:!0,index:!0},displayName:{type:String,required:!1,default:""},player1DeviceId:{type:String,required:!0,index:!0},player2DeviceId:{type:String,default:null,index:!0},status:{type:String,enum:["pending","active","completed","abandoned"],default:"pending"},currentTurn:{type:Number,default:0},currentPlayerIndex:{type:Number,default:0},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now},winnerId:{type:String,default:null},endReason:{type:String,enum:["victory","forfeit","draw",null],default:null},lastTurnAt:{type:Date,default:null},mapData:{type:t.Schema.Types.Mixed,default:{}},isPrivate:{type:Boolean,default:!1},currentState:{type:n,default:()=>({units:[],blockedTiles:[]})}});t.default.models.Battle&&delete t.default.models.Battle;let l=t.default.model("Battle",i);e.s(["Battle",0,l],35930);var s=e.i(89171),d=e.i(76214),o=e.i(94069),u=e.i(68105);async function p(e){let t=e.headers.get("authorization");if(!t||!t.startsWith("Bearer "))return null;let a=t.substring(7);if(!a)return null;await (0,d.connectToDatabase)();let r=(0,u.hashToken)(a),n=await o.Device.findOne({tokenHash:r,isActive:!0});return n?(n.lastSeen=new Date,await n.save(),{deviceId:n.deviceId}):null}function c(e="Unauthorized"){return s.NextResponse.json({success:!1,error:e},{status:401})}e.s(["authenticateDevice",()=>p,"unauthorizedResponse",()=>c],5625)},16907,e=>{"use strict";var t=e.i(47909),a=e.i(74017),r=e.i(96250),n=e.i(59756),i=e.i(61916),l=e.i(74677),s=e.i(69741),d=e.i(16795),o=e.i(87718),u=e.i(95169),p=e.i(47587),c=e.i(66012),y=e.i(70101),v=e.i(26937),f=e.i(10372),h=e.i(93695);e.i(52474);var m=e.i(220),x=e.i(89171),w=e.i(76214),R=e.i(35930),g=e.i(94069),I=e.i(5625);async function D(e){let t=e.filter(e=>null!==e);if(0===t.length)return new Map;let a=await g.Device.find({deviceId:{$in:t}}),r=new Map;for(let e of a)r.set(e.deviceId,{displayName:e.displayName||"Unknown Player",avatar:e.avatar||"BIRD1"});return r}async function b(e,t){let a=new Date;for(let t of e){if("active"!==t.status||!t.player1DeviceId||!t.player2DeviceId)continue;let e=t.lastTurnAt||t.updatedAt;if(a.getTime()-new Date(e).getTime()<6048e5)continue;let r=[t.player1DeviceId,t.player2DeviceId][t.currentPlayerIndex];if(r){let e=r===t.player1DeviceId?t.player2DeviceId:t.player1DeviceId;t.status="completed",t.winnerId=e,t.endReason="forfeit",t.updatedAt=a,await t.save()}}}async function A(e){try{let t=await (0,I.authenticateDevice)(e);if(!t)return(0,I.unauthorizedResponse)("Device authentication required");await (0,w.connectToDatabase)();let{searchParams:a}=new URL(e.url),r=a.get("status"),n={$or:[{player1DeviceId:t.deviceId},{player2DeviceId:t.deviceId}]};r&&["pending","active","completed","abandoned"].includes(r)&&(n.status=r);let i=await R.Battle.find(n).sort({updatedAt:-1}).limit(100);await b(i,t.deviceId);let l=await R.Battle.find(n).sort({updatedAt:-1}).limit(100),s=l.flatMap(e=>[e.player1DeviceId,e.player2DeviceId]),d=await D(s),o=l.map(e=>{let t=e.toObject(),a=d.get(e.player1DeviceId),r=e.player2DeviceId?d.get(e.player2DeviceId):null;return{_id:t._id,battleId:t.battleId,displayName:t.displayName,player1DeviceId:t.player1DeviceId,player1DisplayName:a?.displayName||"Unknown Player",player1Avatar:a?.avatar||"BIRD1",player2DeviceId:t.player2DeviceId,player2DisplayName:r?.displayName||null,player2Avatar:r?.avatar||null,status:t.status,currentTurn:t.currentTurn,currentPlayerIndex:t.currentPlayerIndex,winnerId:t.winnerId,endReason:t.endReason,lastTurnAt:t.lastTurnAt,createdAt:t.createdAt,updatedAt:t.updatedAt,isPrivate:t.isPrivate,mapData:t.mapData,currentState:t.currentState}});return x.NextResponse.json({success:!0,battles:o,count:o.length})}catch(e){return console.error("Fetch my battles error:",e),x.NextResponse.json({success:!1,error:"Failed to fetch battles"},{status:500})}}e.s(["GET",()=>A],26454);var E=e.i(26454);let N=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/mybattles/route",pathname:"/api/mybattles",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/mybattles/route.ts",nextConfigOutput:"",userland:E}),{workAsyncStorage:T,workUnitAsyncStorage:S,serverHooks:C}=N;function q(){return(0,r.patchFetch)({workAsyncStorage:T,workUnitAsyncStorage:S})}async function P(e,t,r){N.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let x="/api/mybattles/route";x=x.replace(/\/index$/,"")||"/";let w=await N.prepare(e,t,{srcPage:x,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:R,params:g,nextConfig:I,parsedUrl:D,isDraftMode:b,prerenderManifest:A,routerServerContext:E,isOnDemandRevalidate:T,revalidateOnlyGenerated:S,resolvedPathname:C,clientReferenceManifest:q,serverActionsManifest:P}=w,k=(0,s.normalizeAppPath)(x),_=!!(A.dynamicRoutes[k]||A.routes[C]),O=async()=>((null==E?void 0:E.render404)?await E.render404(e,t,D,!1):t.end("This page could not be found"),null);if(_&&!b){let e=!!A.routes[C],t=A.dynamicRoutes[k];if(t&&!1===t.fallback&&!e){if(I.experimental.adapterPath)return await O();throw new h.NoFallbackError}}let j=null;!_||N.isDev||b||(j="/index"===(j=C)?"/":j);let U=!0===N.isDev||!_,H=_&&!U;P&&q&&(0,l.setManifestsSingleton)({page:x,clientReferenceManifest:q,serverActionsManifest:P});let M=e.method||"GET",B=(0,i.getTracer)(),$=B.getActiveScopeSpan(),F={params:g,prerenderManifest:A,renderOpts:{experimental:{authInterrupts:!!I.experimental.authInterrupts},cacheComponents:!!I.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:I.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r,n)=>N.onRequestError(e,t,r,n,E)},sharedContext:{buildId:R}},K=new d.NodeNextRequest(e),L=new d.NodeNextResponse(t),z=o.NextRequestAdapter.fromNodeNextRequest(K,(0,o.signalFromNodeResponse)(t));try{let l=async e=>N.handle(z,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=B.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${M} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${M} ${x}`)}),s=!!(0,n.getRequestMeta)(e,"minimalMode"),d=async n=>{var i,d;let o=async({previousCacheEntry:a})=>{try{if(!s&&T&&S&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await l(n);e.fetchMetrics=F.renderOpts.fetchMetrics;let d=F.renderOpts.pendingWaitUntil;d&&r.waitUntil&&(r.waitUntil(d),d=void 0);let o=F.renderOpts.collectedTags;if(!_)return await (0,c.sendResponse)(K,L,i,F.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,y.toNodeOutgoingHttpHeaders)(i.headers);o&&(t[f.NEXT_CACHE_TAGS_HEADER]=o),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,r=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:m.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==a?void 0:a.isStale)&&await N.onRequestError(e,t,{routerKind:"App Router",routePath:x,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:T})},!1,E),t}},u=await N.handleResponse({req:e,nextConfig:I,cacheKey:j,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:A,isRoutePPREnabled:!1,isOnDemandRevalidate:T,revalidateOnlyGenerated:S,responseGenerator:o,waitUntil:r.waitUntil,isMinimalMode:s});if(!_)return null;if((null==u||null==(i=u.value)?void 0:i.kind)!==m.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(d=u.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",T?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),b&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let h=(0,y.fromNodeOutgoingHttpHeaders)(u.value.headers);return s&&_||h.delete(f.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||h.get("Cache-Control")||h.set("Cache-Control",(0,v.getCacheControlHeader)(u.cacheControl)),await (0,c.sendResponse)(K,L,new Response(u.value.body,{headers:h,status:u.value.status||200})),null};$?await d($):await B.withPropagatedContext(e.headers,()=>B.trace(u.BaseServerSpan.handleRequest,{spanName:`${M} ${x}`,kind:i.SpanKind.SERVER,attributes:{"http.method":M,"http.target":e.url}},d))}catch(t){if(t instanceof h.NoFallbackError||await N.onRequestError(e,t,{routerKind:"App Router",routePath:k,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:T})},!1,E),_)throw t;return await (0,c.sendResponse)(K,L,new Response(null,{status:500})),null}}e.s(["handler",()=>P,"patchFetch",()=>q,"routeModule",()=>N,"serverHooks",()=>C,"workAsyncStorage",()=>T,"workUnitAsyncStorage",()=>S],16907)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__2f2e9219._.js.map